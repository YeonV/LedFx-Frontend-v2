# ðŸ¤– AI Agent Instructions: LedFx Multi-Repo Architecture

**CRITICAL Directives for AI Agents:** 
1. **Never assume the environment is running.** Always start and verify the servers using the exact commands and success criteria below.
2. **Respect Package Managers:** The Backend uses `uv`, the Frontend uses `yarn`, and the Audio-Visualiser uses `pnpm`. Do not mix these up.
3. **Respect Auto-Generated Code:** Never edit files inside any `_generated` directory.

---

## ðŸ—ºï¸ Project Topology

This is a distributed, multi-repo ecosystem. You are currently operating inside the **Frontend** repository.

### Core Architecture
- **Backend (Python):** https://github.com/LedFx/LedFx
- **Frontend (React):** https://github.com/YeonV/LedFx-Frontend-v2
- **Audio-Visualiser (React Module):** https://github.com/YeonV/audio-visualiser
- **Dynamic Module Loader:** https://github.com/YeonV/react-dynamic-module (Custom package by YeonV used to link Frontend & Visualiser)

### Pipelines & Distribution
- **Build Pipeline:** https://github.com/YeonV/LedFx-Builds
  - *Trigger Flow:* `Frontend/release.yml` -> `LedFx-Builds/BuildPipelineUV.yml` + `BuildAndroidMatrix.yml`
  - *Binaries:* Published to LedFx-Builds/releases

### Satellite Ecosystem (Context Only - Do Not Modify)
- **Live App:** https://ledfx.stream/
- **Downloads Site:** https://get.ledfx.stream/ (Source: https://github.com/YeonV/ledfx-web)
- **Home Assistant Addon:** https://github.com/YeonV/home-assistant-addons
- **Frontend Storybook:** https://docs.ledfx.stream/
- **Frontend TypeDoc:** https://typedoc.ledfx.stream/
- **Backend Docs:** https://docs.ledfx.app/

---

## ðŸš€ Local Development Setup & Verification

To work on frontend features, you must clone and run both the Backend and Frontend. Open two separate terminal instances.

### Terminal 1: Backend (Port 8888)
1. `cd .. && git clone https://github.com/LedFx/LedFx.git`
2. `cd LedFx`
3. `uv install ledfx`
4. `uv run ledfx --offline -vv`

### Terminal 2: Frontend (Port 3000)
From the root of this frontend repository:
1. `yarn install`
2. `yarn start`

### ðŸ”’ Strict Verification (REQUIRED)
Do not proceed with code changes until you verify both APIs are responding correctly.

- **Verify Backend:** Run `curl -s http://localhost:8888/api/info`
  - *Success:* Response JSON must contain `"name"` field with the string `"LedFx"`.
- **Verify Frontend:** Run `curl -s http://localhost:3000/manifest.json`
  - *Success:* Response JSON must contain `"name"` field with the string `"Blade"`.

---

## ðŸŽ¨ Working with the Audio-Visualiser

The audio-visualiser is a standalone library compiled into a dynamic module (`yz-audio-visualiser.js`). It is injected into the Frontend at runtime.

If your task involves the visualiser, follow these steps:

### 1. Setup the Visualiser Workspace
1. `cd .. && git clone https://github.com/YeonV/audio-visualiser.git`
2. `cd audio-visualiser`
3. `pnpm i`
4. `pnpm dev` (Runs on Port `3001`)

### 2. Read the Visualiser Documentation
The Visualiser is highly complex and utilizes heavy auto-generation. Before modifying its logic, read the index map:
`cat ../audio-visualiser/docs/README.md`
*(Use this README to find specific docs on `ARCHITECTURE.md`, `ZUSTAND_STORE.md`, or `GENERATORS.md`.)*

### 3. The `postbuild` Gotcha (CRITICAL)
When you are ready to build the visualiser for the frontend, you must run `pnpm build`. 
**WARNING:** The `postbuild` script inside `audio-visualiser/package.json` copies `.js` and `.d.ts` files to `../frontend`. 
- **Action Required:** Before running `pnpm build`, check the `package.json` and modify the `postbuild` script path to exactly match the folder name of this Frontend repository (e.g., `../LedFx-Frontend-v2`) so the copy succeeds.

### 4. State Management Paradigm (Generation 5)
When making changes to how the Frontend communicates with the Visualiser, strictly adhere to the current Zustand paradigm:
- **`useStore`:** Global frontend state.
- **`useVstore`:** Direct access to the dynamically loaded Visualiser's internal state.
- **DO NOT** use prop drilling.
- **DO NOT** use `window.api` for state updates.
- **DO NOT** write polling intervals.
- The states are fully reactive. Read `../audio-visualiser/docs/COMMUNICATION.md` if you are confused.

---

## ðŸ§ª Testing

We use Playwright for end-to-end testing to verify the frontend's integration with the Backend and Audio-Visualiser.

### 1. Preparation
Ensure all services are running before starting tests:
- **Backend:** Port 8888 (See Terminal 1 instructions above)
- **Frontend:** Port 3000 (See Terminal 2 instructions above)
- **Visualiser:** Port 3001 (Optional, required for visualiser tests)

### 2. Running Tests
- **Run all tests:** `yarn test:pw`
- **Run specific test:** `npx playwright test tests/initial-load.spec.ts`
- **Debug with UI:** `npx playwright test --ui`

### 3. Handling UI Overlays
The application features several modal overlays on initial load that must be handled in tests:
- **Host Selection:** Appears if no backend is remembered. Look for `http://localhost:8888`.
- **Setup Assistant (Intro):** Appears on first load. Click the **Skip** button to reach the dashboard.

### 4. Visualiser Development Testing
The visualiser tests rely on the module being served from port 3001. When testing the visualiser, ensure the dev server in `audio-visualiser/` is active. Visualiser rendering often requires a safety delay (e.g., `page.waitForTimeout(5000)`) to allow the dynamic module to fully initialize.

### 5. Writing New Tests
- **Location:** `tests/`
- **Naming:** Use `.spec.ts` suffix.
- **Verification:** Always verify UI state changes and capture screenshots for visual inspection using `page.screenshot()`.